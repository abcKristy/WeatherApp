name: Android CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“¦ Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: ğŸ” Debug - Check files
        run: |
          echo "=== Repository structure ==="
          ls -la
          echo "=== Docker Compose file ==="
          if [ -f "docker-compose.yml" ]; then
            cat docker-compose.yml
          else
            echo "âŒ docker-compose.yml not found!"
            find . -name "*.yml" -o -name "*.yaml"
          fi

      - name: ğŸ—ï¸ Build Android APK
        run: |
          docker-compose up --build -d
          sleep 60  # Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ» Ğ²Ñ€ĞµĞ¼Ñ Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ
          docker ps -a
          docker cp weather-android-builder-1:/opt/project/app/build/outputs/ ./output/ || echo "âŒ Failed to copy APK"

      - name: âœ… Verify APK
        run: |
          echo "=== Checking output ==="
          if [ -d "output" ]; then
            find ./output -type f 2>/dev/null
            if [ -f "output/apk/debug/app-debug.apk" ]; then
              echo "âœ… APK found!"
              ls -la output/apk/debug/
              file output/apk/debug/app-debug.apk
            else
              echo "âŒ APK not found in expected location!"
            fi
          else
            echo "âŒ No output directory!"
          fi

      - name: ğŸ“¦ Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: output/apk/debug/app-debug.apk
          retention-days: 30

      - name: ğŸ§¹ Cleanup
        if: always()
        run: docker-compose down || echo "Cleanup failed"